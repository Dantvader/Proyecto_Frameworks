<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Usuario</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyCw8ae27O1Bg8MNBZDKrB55jciUld6plOc",
        authDomain: "becauaqbd.firebaseapp.com",
        projectId: "becauaqbd",
        storageBucket: "becauaqbd.firebasestorage.app",
        messagingSenderId: "853997069826",
        appId: "1:853997069826:web:50e1a3812626cf4255a91b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    window.firebaseApp = app;
    window.firebaseDB = db;
    window.firebaseModules = { 
        collection, doc, getDoc, setDoc, updateDoc, query, where, getDocs 
    };
  </script>

  <style>
    :root {
      --azul: #44658a;
      --fondo: #e9fdfd;
      --caja: white;
      --borde-radio: 18px;
    }

    body {
      margin: 0;
      background: var(--fondo);
      font-family: "Segoe UI", sans-serif;
      color: black;
    }

    /* Header */
    .header {
      background-color: var(--azul);
      color: white;
      padding: 18px 30px;
      border-bottom-left-radius: 45px;
      border-bottom-right-radius: 45px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-icon {
      width: 55px;
      height: 55px;
      background: #b9ecf5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: var(--azul);
    }

    .home-icon {
      background: var(--azul);
      border: 2px solid white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      cursor: pointer;
      font-size: 25px;
    }

    /* Contenido */
    .content {
      padding: 25px;
      margin-bottom: 90px;
    }

    .section {
      display: none;
      background: var(--caja);
      padding: 20px;
      border-radius: var(--borde-radio);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .active {
      display: block;
    }

    /* Footer */
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--azul);
      padding: 12px;
      display: flex;
      justify-content: space-around;
      color: white;
      border-top-left-radius: 25px;
      border-top-right-radius: 25px;
    }

    .footer button {
      background: none;
      border: none;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }

    .footer button:hover {
      text-decoration: underline;
    }
    
    /* Estilos espec√≠ficos para la secci√≥n de renovaci√≥n */
    #renovacion .container {
      max-width: 900px;
      margin: 0 auto;
    }

    #renovacion .data-box {
      background: #fff;
      border-left: 10px solid #44658a;
      padding: 18px;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgba(0,0,0,.12);
      margin-bottom: 18px;
      display: flex;
      gap: 16px;
      align-items: center;
    }

    #renovacion .avatar {
      width: 72px;
      height: 72px;
      border-radius: 10px;
      object-fit: cover;
      border: 2px solid #e6f3f7;
      background: #fff;
    }

    #renovacion .data-box .info p {
      margin: 6px 0;
      font-size: 1em;
      color: #222;
    }

    #renovacion #estadoBeca {
      font-weight: 700;
    }

    #renovacion .option-box {
      background: #fff;
      border-left: 10px solid #00a1a7;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgba(0,0,0,.08);
    }

    #renovacion .radio-group {
      display: flex;
      gap: 28px;
      font-size: 1.05em;
      margin-top: 6px;
    }

    #renovacion input[type="radio"] {
      transform: scale(1.15);
      margin-right: 8px;
    }

    #renovacion .file-upload {
      margin-top: 14px;
      display: none;
    }

    #renovacion input[type="file"] {
      padding: 12px;
      border: 2px solid #44658a;
      background: #e8f9fb;
      border-radius: 10px;
      width: 100%;
      cursor: pointer;
    }

    #renovacion .btn {
      margin-top: 20px;
      background: #44658a;
      color: #fff;
      border: none;
      width: 100%;
      height: 46px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.05em;
    }

    #renovacion .btn:hover {
      background: #35506d;
    }

    #renovacion .alert {
      display: none;
      padding: 12px 18px;
      border-radius: 8px;
      color: #fff;
      text-align: center;
      margin-top: 14px;
      font-weight: 600;
    }

    #renovacion .state-pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 700;
    }

    /* Estilos para PDF viewers */
    .pdf-viewer {
      width: 100%;
      height: 600px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    .form-container {
      margin: 20px 0;
    }

    .buttons {
      margin-top: 15px;
      text-align: center;
    }

    .buttons button {
      background-color: var(--azul);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 0 10px;
    }

    /* ESTILOS PARA LA SECCI√ìN DE REGISTRO */
    #registro .form-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        max-width: 500px;
        margin: 0 auto;
    }

    #registro label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #24496f;
    }

    #registro input[type="text"],
    #registro input[type="email"] {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        box-sizing: border-box;
        transition: border-color 0.3s ease;
    }

    #registro input[type="text"]:focus,
    #registro input[type="email"]:focus {
        border-color: #44658a;
        outline: none;
        box-shadow: 0 0 5px rgba(68, 101, 138, 0.3);
    }

    #registro .buttons {
        text-align: center;
        margin-top: 20px;
    }

    #registro .buttons button {
        background-color: var(--azul);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.05em;
        transition: background-color 0.3s ease;
    }

    #registro .buttons button:hover {
        background-color: #35506d;
    }

    /* Estado de beca en registro */
    #estadoBecaInfo {
        display: none;
        margin: 20px 0;
        padding: 15px;
        border-radius: 8px;
        background: #f8f9fa;
        border-left: 5px solid #44658a;
    }

    #mensajeEstado {
        margin: 0;
        line-height: 1.5;
        color: #333;
    }

    /* Resultado del registro */
    #registroResultado {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
    }
  </style>

</head>

<body>

  <div class="header">
    <div class="user-info">
      <div class="user-icon">üë§</div>
      <div>
        <div><strong id="userName">Usuario</strong></div>
        <div id="userId">ID-Usuario</div>
      </div>
    </div>

    <div class="home-icon" onclick="showSection('inicio')">üè†</div>
  </div>

  <div class="content">

    <!-- home -->
    <div id="inicio" class="section active">
      <h2>Bienvenido</h2>
      <p>Seleccione una opci√≥n del men√∫ inferior.</p>
    </div>

    <!-- Convocatorias -->
    <div id="convocatoria" class="section">
      <h2>Convocatoria</h2>
      <div class="form-container">
        <iframe class="pdf-viewer" src="https://dantvader.github.io/Proyecto_Frameworks/recursos/convocatoria.pdf"></iframe>
        <div class="buttons">
           <a href="recursos/convocatoria.pdf" download="convocatoria-becas.pdf">
              <button>Descargar PDF</button>
          </a>
        </div>
      </div>
    </div>

        <!-- Registro -->
    <div id="registro" class="section">
      <h2>Registro</h2>
      <div class="form-container"> 
        <label for="nombre">Nombre completo:</label> 
        <input type="text" id="nombre" placeholder="Ingrese su nombre completo"> 
            
        <label for="correo">Correo electr√≥nico:</label> 
        <input type="email" id="correo" placeholder="Ingrese su correo"> 
            
        <label for="expediente">Expediente:</label> 
        <input type="text" id="expediente" placeholder="Ingrese su n√∫mero de expediente"> 
            
        <!-- Estado de beca que se actualizar√° din√°micamente -->
        <div id="estadoBecaInfo" style="display: none; margin: 15px 0; padding: 10px; border-radius: 8px;">
          <h4 style="margin: 0 0 8px 0;">Estado de Beca:</h4>
          <p id="mensajeEstado" style="margin: 0; font-weight: 500;"></p>
        </div>
            
        <div class="buttons">
          <button type="button" onclick="verificarYRegistrar()">Verificar y Registrar</button> 
        </div>
            
        <div id="registroResultado" style="margin-top: 15px; display: none;"></div>
      </div>
    </div>

    <!-- Renovaci√≥n -->
    <div id="renovacion" class="section">
    <h2>Renovaci√≥n</h2>
    <div class="container">
        <!-- DATOS DEL BECARIO -->
      <div class="data-box">
        <img class="avatar" src="recursos/imagenes/avatar-default.png" alt="avatar">
          <div class="info">
              <p><strong>Nombre:</strong> <span id="renovacionNombre">Cargando...</span></p>
              <p><strong>Matr√≠cula:</strong> <span id="renovacionMatricula">Cargando...</span></p>
              <p><strong>Carrera:</strong> <span id="renovacionCarrera">Cargando...</span></p>
              <p><strong>Estado de Beca Actual:</strong>
                <span id="renovacionEstadoBeca" class="state-pill">Cargando...</span>
              </p>
              <p><strong>√öltima actualizaci√≥n:</strong> <span id="renovacionFecha">Cargando...</span></p>
          </div>
      </div>

        <!-- OPCIONES DE RENOVACI√ìN -->
      <div class="option-box">
        <h3 style="margin:0;color:#24496f;">Solicitud de Renovaci√≥n</h3>
        <p style="margin:8px 0 6px;color:#444;">Seleccione una opci√≥n y env√≠e su solicitud. Si elige <em>S√≠</em>, su estado cambiar√° a <strong>Pendiente</strong> hasta que un administrador apruebe.</p>

          <div class="radio-group">
            <label><input type="radio" name="renovar" value="si"> S√≠ deseo renovar</label>
            <label><input type="radio" name="renovar" value="no"> No deseo renovar</label>
          </div>

          <div class="file-upload" id="uploadSection">
            <p style="margin:10px 0 6px;"><strong>Suba el documento (PDF) para renovar:</strong></p>
            <input id="docFile" type="file" accept="application/pdf" />
          </div>

          <button class="btn" onclick="enviarSolicitudRenovacion()">Enviar solicitud</button>

          <div id="alertBox" class="alert"></div>
        </div>
      </div>
    </div>

    <!-- Resultados -->
    <div id="resultados" class="section">
      <h2>Resultados</h2>
      <div class="form-container">
        <iframe class="pdf-viewer" src="https://dantvader.github.io/Proyecto_Frameworks/recursos/resultados-becaspdf"></iframe>
        <div class="buttons">
            <a href="recursos/resultados.pdf" download="resultados-becas.pdf">
              <button>Descargar PDF</button>
            </a>
        </div>
      </div>
    </div>

    <!-- Acerca de -->
    <div id="acerca" class="section">
      <h2>Acerca</h2>
      <div class="content">
        <p>La Aplicaci√≥n de Becas UAQ es un proyecto desarrollado como parte del Proyecto Final de Redes de la Facultad de Inform√°tica de la Universidad Aut√≥noma de Quer√©taro, dentro del programa educativo de Ingenier√≠a de Software.</p>
        <p>Su objetivo principal es brindar una soluci√≥n digital que facilite la gesti√≥n y administraci√≥n de informaci√≥n relacionada con becas estudiantiles, permitiendo a la universidad mantener procesos ordenados, accesibles y eficientes tanto para los estudiantes como para los administradores del sistema.</p>
        <p>Este proyecto surge como respuesta a una problem√°tica com√∫n: la desorganizaci√≥n en los procesos de becas y la falta de comunicaci√≥n clara sobre el estado de las solicitudes. La aplicaci√≥n ofrece una plataforma donde los alumnos pueden consultar el estado de sus entrevistas, documentos y resultados, mientras que los administradores pueden gestionar convocatorias, validar aplicantes y controlar el flujo completo del proceso.</p>
        <p>Para su desarrollo se utilizaron tecnolog√≠as como <b>HTML, CSS, JavaScript, PHP y XAMPP</b>, adem√°s de herramientas de dise√±o como <b>Figma</b> para la creaci√≥n de prototipos y <b>GitHub</b> para la colaboraci√≥n del equipo durante el desarrollo.</p>
        <p>El sistema plantea diferentes vistas seg√∫n el tipo de usuario: estudiantes, administradores suplentes y administradores principales, cada uno con permisos y funciones espec√≠ficas.</p>
        <p>La aplicaci√≥n est√° dise√±ada como un proyecto funcional, modular y escalable, con la capacidad de crecer y adaptarse a necesidades reales dentro del entorno universitario.</p>
      </div>
    </div>

  </div>

  <div class="footer">
    <button onclick="showSection('convocatoria')">Convocatoria</button>
    <button onclick="showSection('registro')">Registro</button>
    <button onclick="showSection('renovacion')">Renovaci√≥n</button>
    <button onclick="showSection('resultados')">Resultados</button>
    <button onclick="showSection('acerca')">Acerca</button>
  </div>

  <script>
        // Funci√≥n para cambiar secciones
    function showSection(id) {
        document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        
        // Cargar convocatoria cuando se muestre esa secci√≥n
        if (id === 'convocatoria') {
            cargarConvocatoria();
        }
    }

    // ========== FUNCIONES DE USUARIO Y AUTENTICACI√ìN ==========

    // Cargar datos del usuario
    async function cargarDatosUsuario() {
        try {
            const usuarioStorage = localStorage.getItem('usuario');
            if (!usuarioStorage) {
                window.location.href = 'index.html';
                return;
            }

            const usuarioData = JSON.parse(usuarioStorage);
            
            // Actualizar header
            const userNameElement = document.getElementById('userName');
            const userIdElement = document.getElementById('userId');

            if (usuarioData.nombre) {
                userNameElement.textContent = usuarioData.nombre;
            }
            if (usuarioData.id) {
                userIdElement.textContent = `ID: ${usuarioData.id}`;
            }

            // Cargar datos espec√≠ficos para renovaci√≥n
            cargarDatosBeca(usuarioData);

        } catch (error) {
            console.error('Error al cargar datos del usuario:', error);
        }
    }

    // ========== FUNCIONES DE RENOVACI√ìN  ==========

    // Funci√≥n para cargar datos de beca del estudiante
    async function cargarDatosBeca(usuarioData) {
        try {
            console.log('üìä Cargando datos de beca para:', usuarioData.id);
            
            const { doc, getDoc, setDoc } = window.firebaseModules;
            
            // Buscar en la colecci√≥n "becas" usando el ID del estudiante
            const becaRef = doc(window.firebaseDB, "becas", usuarioData.id);
            const becaDoc = await getDoc(becaRef);
            
            if (becaDoc.exists()) {
                // El documento de beca existe
                const becaData = becaDoc.data();
                actualizarInterfazRenovacion(usuarioData, becaData);
            } else {
                // Crear documento de beca si no existe
                const nuevaBeca = {
                    estudianteId: usuarioData.id,
                    estudianteNombre: usuarioData.nombre,
                    activo: false,
                    estado: "No aplica",
                    fechaActualizacion: new Date(),
                    actualizadoPor: "Sistema"
                };
                
                await setDoc(becaRef, nuevaBeca);
                actualizarInterfazRenovacion(usuarioData, nuevaBeca);
                console.log('‚úÖ Nuevo documento de beca creado');
            }
            
        } catch (error) {
            console.error('‚ùå Error al cargar datos de beca:', error);
            // Mostrar datos b√°sicos en caso de error
            actualizarInterfazRenovacion(usuarioData, null);
        }
    }

    // Funci√≥n para actualizar la interfaz con los datos
    function actualizarInterfazRenovacion(usuarioData, becaData) {
        // Datos del usuario
        document.getElementById('renovacionNombre').textContent = usuarioData.nombre || 'No disponible';
        document.getElementById('renovacionMatricula').textContent = usuarioData.id || 'No disponible';
        document.getElementById('renovacionCarrera').textContent = usuarioData.carrera || 'No especificada';
        
        // Datos de la beca
        const estadoElement = document.getElementById('renovacionEstadoBeca');
        const fechaElement = document.getElementById('renovacionFecha');
        
        if (becaData) {
            // Estado de la beca
            const estado = becaData.activo ? "Activa" : (becaData.estado || "Inactiva");
            estadoElement.textContent = estado;
            
            // Fecha de actualizaci√≥n
            if (becaData.fechaActualizacion) {
                const fecha = becaData.fechaActualizacion.toDate ? 
                            becaData.fechaActualizacion.toDate() : 
                            new Date(becaData.fechaActualizacion);
                fechaElement.textContent = fecha.toLocaleDateString('es-ES');
            } else {
                fechaElement.textContent = 'No disponible';
            }
            
            // Aplicar estilos seg√∫n el estado
            aplicarEstilosEstado(estadoElement, estado);
            
        } else {
            estadoElement.textContent = 'No disponible';
            fechaElement.textContent = 'No disponible';
            aplicarEstilosEstado(estadoElement, 'default');
        }
    }

    // Funci√≥n para aplicar estilos al estado
    function aplicarEstilosEstado(elemento, estado) {
        // Resetear estilos
        elemento.style.color = '';
        elemento.style.background = '';
        elemento.style.border = '';
        elemento.style.padding = '4px 10px';
        elemento.style.borderRadius = '12px';
        elemento.style.fontWeight = '700';
        
        switch(estado.toLowerCase()) {
            case 'activa':
                elemento.style.color = 'green';
                elemento.style.background = '#e6f5f5';
                elemento.style.border = '1px solid #cfecec';
                break;
            case 'inactiva':
                elemento.style.color = 'red';
                elemento.style.background = '#fde8e8';
                elemento.style.border = '1px solid #fbd5d5';
                break;
            case 'pendiente':
                elemento.style.color = 'orange';
                elemento.style.background = '#fff3e6';
                elemento.style.border = '1px solid #ffe0b3';
                break;
            case 'no aplica':
                elemento.style.color = 'gray';
                elemento.style.background = '#f5f5f5';
                elemento.style.border = '1px solid #ddd';
                break;
            default:
                elemento.style.color = 'gray';
                elemento.style.background = '#f5f5f5';
                elemento.style.border = '1px solid #ddd';
        }
    }

    // Funci√≥n para enviar solicitud de renovaci√≥n
    async function enviarSolicitudRenovacion() {
        const selectedOption = document.querySelector('input[name="renovar"]:checked');
        const alertBox = document.getElementById('alertBox');
        
        if (!selectedOption) {
            mostrarAlerta('Por favor seleccione una opci√≥n', 'error');
            return;
        }
        
        try {
            const usuarioStorage = localStorage.getItem('usuario');
            if (!usuarioStorage) {
                window.location.href = 'index.html';
                return;
            }
            
            const usuarioData = JSON.parse(usuarioStorage);
            const { doc, updateDoc } = window.firebaseModules;
            const becaRef = doc(window.firebaseDB, "becas", usuarioData.id);
            
            if (selectedOption.value === 'si') {
                const fileInput = document.getElementById('docFile');
                if (!fileInput.files.length) {
                    mostrarAlerta('Por favor suba el documento PDF', 'error');
                    return;
                }
                
                // Actualizar estado a "Pendiente"
                await updateDoc(becaRef, {
                    activo: false,
                    estado: "Pendiente",
                    fechaActualizacion: new Date(),
                    actualizadoPor: usuarioData.nombre || "Estudiante",
                    solicitudRenovacion: true,
                    fechaSolicitud: new Date()
                });
                
                mostrarAlerta('‚úÖ Solicitud de renovaci√≥n enviada correctamente. Estado: Pendiente', 'success');
                
            } else {
                // El estudiante no quiere renovar
                await updateDoc(becaRef, {
                    activo: false,
                    estado: "No renovar√°",
                    fechaActualizacion: new Date(),
                    actualizadoPor: usuarioData.nombre || "Estudiante",
                    solicitudRenovacion: false
                });
                
                mostrarAlerta('Ha decidido no renovar su beca', 'warning');
            }
            
            // Recargar datos para mostrar cambios
            setTimeout(() => cargarDatosBeca(usuarioData), 1000);
            
        } catch (error) {
            console.error('Error al enviar solicitud:', error);
            mostrarAlerta('‚ùå Error al enviar solicitud: ' + error.message, 'error');
        }
    }

    // Funci√≥n para mostrar alertas
    function mostrarAlerta(mensaje, tipo) {
        const alertBox = document.getElementById('alertBox');
        alertBox.textContent = mensaje;
        alertBox.style.display = 'block';
        
        switch(tipo) {
            case 'success':
                alertBox.style.backgroundColor = '#51cf66';
                break;
            case 'error':
                alertBox.style.backgroundColor = '#ff6b6b';
                break;
            case 'warning':
                alertBox.style.backgroundColor = '#ffa94d';
                break;
            default:
                alertBox.style.backgroundColor = '#44658a';
        }
    }

    // ========== FUNCIONES DE CONVOCATORIA ==========

    // Funci√≥n para cargar la convocatoria
    async function cargarConvocatoria() {
        const loadingDiv = document.getElementById('convocatoriaLoading');
        const viewer = document.getElementById('pdfConvocatoriaViewer');
        const buttonsDiv = document.getElementById('convocatoriaButtons');
        const errorDiv = document.getElementById('convocatoriaError');
        
        try {
            // Cargar desde recursos locales
            viewer.src = "recursos/convocatoria.pdf";
            viewer.style.display = 'block';
            buttonsDiv.style.display = 'block';
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
        } catch (error) {
            console.log('Error cargando convocatoria:', error);
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'block';
        }
    }

    // Funci√≥n para descargar convocatoria
    function descargarConvocatoria() {
        const link = document.createElement('a');
        link.href = "recursos/convocatoria.pdf";
        link.download = 'convocatoria-becas.pdf';
        link.click();
    }

    // ========== INICIALIZACI√ìN ==========

    // Mostrar/ocultar upload seg√∫n selecci√≥n en renovaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
        // Cargar datos del usuario
        cargarDatosUsuario();
        
        // Configurar eventos de renovaci√≥n
        const radios = document.querySelectorAll('input[name="renovar"]');
        const uploadSection = document.getElementById('uploadSection');
        
        radios.forEach(radio => {
            radio.addEventListener('change', function() {
                uploadSection.style.display = this.value === 'si' ? 'block' : 'none';
            });
        });
    });

    // Verificaci√≥n de autenticaci√≥n al cargar la p√°gina
    if (!localStorage.getItem('usuario')) {
        window.location.href = 'index.html';
    }

    // ========== FUNCIONES DE REGISTRO ==========

    // Funci√≥n para verificar el estado de la beca
    async function verificarEstadoBeca() {
        try {
            const usuarioStorage = localStorage.getItem('usuario');
            if (!usuarioStorage) {
                return { existe: false, estado: 'no_identificado' };
            }
            
            const usuarioData = JSON.parse(usuarioStorage);
            const { doc, getDoc } = window.firebaseModules;
            
            // Buscar en la colecci√≥n "becas" usando el ID del estudiante
            const becaRef = doc(window.firebaseDB, "becas", usuarioData.id);
            const becaDoc = await getDoc(becaRef);
            
            if (becaDoc.exists()) {
                const becaData = becaDoc.data();
                return {
                    existe: true,
                    activo: becaData.activo || false,
                    estado: becaData.estado || 'Inactiva',
                    fechaActualizacion: becaData.fechaActualizacion,
                    // Agregar estos campos para mostrar en el registro
                    estudianteId: becaData.estudianteId,
                    estudianteNombre: becaData.estudianteNombre
                };
            } else {
                return { 
                    existe: false, 
                    estado: 'no_registrada',
                    estudianteId: usuarioData.id,
                    estudianteNombre: usuarioData.nombre
                };
            }
            
        } catch (error) {
            console.error('Error verificando beca:', error);
            return { 
                existe: false, 
                estado: 'error',
                error: error.message 
            };
        }
    }

    // Funci√≥n para mostrar el estado de la beca en registro 
    function mostrarEstadoBeca(estadoBeca) {
        const estadoInfo = document.getElementById('estadoBecaInfo');
        const mensajeEstado = document.getElementById('mensajeEstado');
        
        estadoInfo.style.display = 'block';
        
        if (!estadoBeca.existe) {
            mensajeEstado.innerHTML = `
                <strong>Matr√≠cula/ID:</strong> ${estadoBeca.estudianteId || 'No disponible'}<br>
                <strong>Nombre:</strong> ${estadoBeca.estudianteNombre || 'No disponible'}<br>
                <strong>Estado de Beca:</strong> ‚ùå No tienes una beca registrada. Puedes solicitar una nueva.
            `;
            estadoInfo.style.backgroundColor = '#fff3cd';
            estadoInfo.style.border = '1px solid #ffeaa7';
            return;
        }
        
        let estadoTexto = '';
        let icono = '';
        
        switch(estadoBeca.estado.toLowerCase()) {
            case 'activa':
                estadoTexto = 'ACTIVA';
                icono = '‚úÖ';
                estadoInfo.style.backgroundColor = '#d1ecf1';
                estadoInfo.style.border = '1px solid #bee5eb';
                break;
                
            case 'inactiva':
                estadoTexto = 'INACTIVA';
                icono = '‚ö†Ô∏è';
                estadoInfo.style.backgroundColor = '#fff3cd';
                estadoInfo.style.border = '1px solid #ffeaa7';
                break;
                
            case 'pendiente':
                estadoTexto = 'PENDIENTE';
                icono = '‚è≥';
                estadoInfo.style.backgroundColor = '#e2e3e5';
                estadoInfo.style.border = '1px solid #d6d8db';
                break;
                
            case 'no renovar√°':
                estadoTexto = 'NO RENOVAR√Å';
                icono = '‚ùå';
                estadoInfo.style.backgroundColor = '#f8d7da';
                estadoInfo.style.border = '1px solid #f5c6cb';
                break;
                
            default:
                estadoTexto = estadoBeca.estado || 'NO DETERMINADO';
                icono = '‚ùì';
                estadoInfo.style.backgroundColor = '#e2e3e5';
                estadoInfo.style.border = '1px solid #d6d8db';
        }
        
        // Mostrar informaci√≥n completa
        mensajeEstado.innerHTML = `
            <strong>Matr√≠cula/ID:</strong> ${estadoBeca.estudianteId || 'No disponible'}<br>
            <strong>Nombre:</strong> ${estadoBeca.estudianteNombre || 'No disponible'}<br>
            <strong>Estado de Beca:</strong> ${icono} ${estadoTexto}<br>
            ${estadoBeca.fechaActualizacion ? `<strong>√öltima actualizaci√≥n:</strong> ${new Date(estadoBeca.fechaActualizacion.seconds * 1000).toLocaleDateString('es-ES')}` : ''}
        `;
    }

    // Funci√≥n para realizar el registro 
    async function realizarRegistro(nombre, correo, expediente, estadoBeca) {
        try {
            const usuarioStorage = localStorage.getItem('usuario');
            const usuarioData = JSON.parse(usuarioStorage);
            
            const { doc, setDoc, updateDoc } = window.firebaseModules;
            
            // Si no existe beca, crear una nueva en la colecci√≥n "becas"
            if (!estadoBeca.existe) {
                const nuevaBecaRef = doc(window.firebaseDB, "becas", usuarioData.id);
                await setDoc(nuevaBecaRef, {
                    estudianteId: usuarioData.id,
                    estudianteNombre: nombre || usuarioData.nombre,
                    activo: false,
                    estado: "Pendiente",
                    fechaActualizacion: new Date(),
                    actualizadoPor: "Sistema",
                    correo: correo,
                    expediente: expediente,
                    fechaSolicitud: new Date()
                });
            } else {
                // Actualizar la beca existente si es necesario
                const becaRef = doc(window.firebaseDB, "becas", usuarioData.id);
                await updateDoc(becaRef, {
                    estudianteNombre: nombre || estadoBeca.estudianteNombre,
                    correo: correo,
                    expediente: expediente,
                    fechaActualizacion: new Date(),
                    actualizadoPor: "Estudiante"
                });
            }
            
            // Guardar tambi√©n en la colecci√≥n "solicitudes" para historial
            const registroData = {
                estudianteId: usuarioData.id,
                estudianteNombre: usuarioData.nombre,
                nombreCompleto: nombre,
                correo: correo,
                expediente: expediente,
                estadoBeca: estadoBeca.existe ? estadoBeca.estado : 'Nueva Solicitud',
                fechaRegistro: new Date(),
                tipoSolicitud: determinarTipoSolicitud(estadoBeca)
            };
            
            const registroRef = doc(window.firebaseDB, "solicitudes", `${usuarioData.id}_${Date.now()}`);
            await setDoc(registroRef, registroData);
            
            // Mostrar mensaje seg√∫n el estado de la beca
            const mensaje = generarMensajeRegistro(estadoBeca);
            mostrarResultadoRegistro(mensaje, 'success');
            
            // Limpiar formulario
            document.getElementById('nombre').value = '';
            document.getElementById('correo').value = '';
            document.getElementById('expediente').value = '';
            
            // Recargar estado de beca para mostrar cambios
            setTimeout(() => cargarEstadoBecaRegistro(), 1000);
            
        } catch (error) {
            console.error('Error en registro:', error);
            mostrarResultadoRegistro('Error al guardar el registro: ' + error.message, 'error');
        }
    }

    // Funci√≥n para cargar estado de beca en registro 
    async function cargarEstadoBecaRegistro() {
        try {
            const estadoBeca = await verificarEstadoBeca();
            mostrarEstadoBeca(estadoBeca);
            
            // Tambi√©n actualizar los campos del formulario con datos existentes
            if (estadoBeca.existe && estadoBeca.estudianteNombre) {
                document.getElementById('nombre').value = estadoBeca.estudianteNombre;
            }
            
        } catch (error) {
            console.error('Error cargando estado de beca:', error);
            mostrarResultadoRegistro('Error al cargar informaci√≥n de beca: ' + error.message, 'error');
        }
    }
  </script>

</body>
</html>