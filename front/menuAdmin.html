<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administrador</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --azul: #44658a;
      --fondo: #e9fdfd;
      --caja: white;
      --borde-radio: 18px;
      --entrevista-color: #e6f2ff;
      --entrevista-borde: #b3d9ff;
      --verde: #4CAF50;
      --rojo: #f44336;
    }

    body {
      margin: 0;
      background: var(--fondo);
      font-family: "Segoe UI", sans-serif;
    }

    .header {
      background-color: var(--azul);
      color: white;
      padding: 18px 30px;
      border-bottom-left-radius: 45px;
      border-bottom-right-radius: 45px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-icon {
      width: 55px;
      height: 55px;
      background: #b9ecf5;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 32px;
      color: var(--azul);
    }

    .home-icon {
      width: 50px;
      height: 50px;
      background: var(--azul);
      border: 2px solid white;
      border-radius: 50%;
      display: grid;
      place-items: center;
      cursor: pointer;
    }

    .content {
      padding: 25px;
      margin-bottom: 90px;
    }

    .section {
      display: none;
      background: var(--caja);
      padding: 20px;
      border-radius: var(--borde-radio);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .active {
      display: block;
    }

    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-around;
      background: var(--azul);
      padding: 12px;
      border-top-left-radius: 25px;
      border-top-right-radius: 25px;
    }

    .footer button {
      background: none;
      border: none;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }

    .footer button:hover {
      text-decoration: underline;
    }

    /* Estilos para gesti√≥n de becas */
    .students-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .student-card {
      background: white;
      border-radius: var(--borde-radio);
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 2px solid #e0e0e0;
      transition: all 0.3s ease;
    }

    .student-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }

    .student-info {
      margin-bottom: 15px;
    }

    .student-field {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 5px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .field-label {
      font-weight: bold;
      color: var(--azul);
    }

    .field-value {
      color: #333;
    }

    .status-section {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #e0e0e0;
    }

    .status-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .status-indicator {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .status-active {
      background-color: var(--verde);
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
    }

    .status-inactive {
      background-color: var(--rojo);
      box-shadow: 0 0 10px rgba(244, 67, 54, 0.3);
    }

    .status-text {
      font-weight: bold;
      font-size: 0.9rem;
    }

    .status-active-text {
      color: var(--verde);
    }

    .status-inactive-text {
      color: var(--rojo);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 1.1rem;
    }

    .error {
      text-align: center;
      padding: 20px;
      color: #d32f2f;
      background-color: #ffebee;
      border-radius: 5px;
      margin: 10px 0;
    }

    .search-box {
      margin-bottom: 20px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: var(--borde-radio);
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: var(--azul);
    }

    /* Estilos del calendario (mantener los existentes) */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .calendar-nav {
      display: flex;
      gap: 10px;
    }

    .calendar-nav button {
      background-color: var(--azul);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 12px;
      cursor: pointer;
    }

    .calendar-nav button:hover {
      background-color: #365a7a;
    }

    .week-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .day-header {
      text-align: center;
      font-weight: bold;
      padding: 10px;
      background-color: var(--azul);
      color: white;
      border-radius: 8px 8px 0 0;
    }

    .day-column {
      background-color: #f9f9f9;
      border-radius: 0 0 8px 8px;
      min-height: 400px;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .interview-card {
      background-color: var(--entrevista-color);
      border: 1px solid var(--entrevista-borde);
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 0.85rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      cursor: pointer;
    }

    .interview-card:hover {
      background-color: #d4e6ff;
    }

    .interview-time {
      font-weight: bold;
      color: var(--azul);
    }

    .interview-candidate {
      font-weight: 500;
      margin: 4px 0;
    }

    .interview-position {
      font-size: 0.8rem;
      color: #666;
    }

    .empty-day {
      color: #999;
      text-align: center;
      padding: 20px;
      font-style: italic;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: white;
      padding: 25px;
      border-radius: var(--borde-radio);
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
    }

    .btn-primary {
      background-color: var(--azul);
      color: white;
    }

    .btn-secondary {
      background-color: #ddd;
      color: #333;
    }

    .student-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-top: 10px;
    }

    .student-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .student-item:hover {
      background-color: #f5f5f5;
    }

    .student-item:last-child {
      border-bottom: none;
    }

    .selected-student {
      background-color: var(--entrevista-color);
      border-left: 3px solid var(--azul);
    }
  </style>

</head>

<body>

  <div class="header">
    <div class="user-info">
      <div class="user-icon">üë§</div>
      <div>
        <div><strong id="admin-name">Administrador</strong></div>
        <div id="admin-id">ID-usuario</div>
      </div>
    </div>
    <div class="home-icon" onclick="showSection('inicio')">üè†</div>
  </div>

  <div class="content">

    <!---  home  -->
    <div id="inicio" class="section active">
      <h2>Bienvenido</h2>
      <p>Seleccione una opci√≥n del men√∫ inferior.</p>
    </div>

    <!--- Editar Convocatoria  -->
    <div id="validacion" class="section">
      <h2>Editar Convocatoria</h2>
      <p>
        <div class="form-container">
        <form action="/subir-convocatoria" method="POST" enctype="multipart/form-data">
        <input type="file" name="pdf" accept="application/pdf" required />
        <button type="submit">Subir nuevo PDF</button>
    </form>
</div>
      </p>
    </div>

    <!---  Administrar Entrevistas -->
    <div id="seguimiento" class="section">
      <h2>Calendario de Entrevistas</h2>
      
      <div class="calendar-header">
        <h3 id="current-week">Semana actual</h3>
        <div class="calendar-nav">
          <button id="prev-week">‚Üê Semana anterior</button>
          <button id="today">Hoy</button>
          <button id="next-week">Semana siguiente ‚Üí</button>
        </div>
      </div>
      
      <div class="week-calendar">
        <div class="day-header">Lunes</div>
        <div class="day-header">Martes</div>
        <div class="day-header">Mi√©rcoles</div>
        <div class="day-header">Jueves</div>
        <div class="day-header">Viernes</div>
        <div class="day-header">S√°bado</div>
        <div class="day-header">Domingo</div>
        
        <div class="day-column" id="monday" data-day="1">
          <div class="loading">Cargando entrevistas...</div>
        </div>
        
        <div class="day-column" id="tuesday" data-day="2">
          <div class="loading">Cargando entrevistas...</div>
        </div>
        
        <div class="day-column" id="wednesday" data-day="3">
          <div class="loading">Cargando entrevistas...</div>
        </div>
        
        <div class="day-column" id="thursday" data-day="4">
          <div class="loading">Cargando entrevistas...</div>
        </div>
        
        <div class="day-column" id="friday" data-day="5">
          <div class="loading">Cargando entrevistas...</div>
        </div>
        
        <div class="day-column" id="saturday" data-day="6">
          <div class="loading">Cargando entrevistas...</div>
        </div>
        
        <div class="day-column" id="sunday" data-day="0">
          <div class="loading">Cargando entrevistas...</div>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 20px;">
        <button id="add-interview-btn" style="background-color: var(--azul); color: white; border: none; border-radius: 5px; padding: 10px 20px; cursor: pointer;">
          Agregar Nueva Entrevista
        </button>
      </div>
    </div>

    <!--- Gestion de Becas  -->
    <div id="publicacion" class="section">
      <h2>Gesti√≥n de Becas</h2>
      
      <div class="search-box">
        <input type="text" id="student-search" placeholder="Buscar estudiante por nombre o ID...">
      </div>
      
      <div id="students-container">
        <div class="loading">Cargando estudiantes...</div>
      </div>
    </div>

    <!---  Registro Respuestas -->
    <div id="preguntas" class="section">
      <h2>Registro Respuestas</h2>
      <p>
        <div class="form-container">
          <form action="/subir-resultados" method="POST" enctype="multipart/form-data">
              <input type="file" name="pdf" accept="application/pdf" required />
              <button type="submit">Subir nuevo PDF</button>
          </form>
        </div>
      </p>
    </div>

    <!--- Acerca de  -->
    <div id="acerca" class="section">
      <h2>Acerca</h2>
      <div class="content">
        <p>
          La Aplicaci√≥n de Becas UAQ es un proyecto desarrollado como parte del Proyecto Final de Redes de la Facultad de Inform√°tica de la Universidad Aut√≥noma de Quer√©taro, dentro del programa educativo de Ingenier√≠a de Software.
        </p>

        <p>
          Su objetivo principal es brindar una soluci√≥n digital que facilite la gesti√≥n y administraci√≥n de informaci√≥n relacionada con becas estudiantiles, permitiendo a la universidad mantener procesos ordenados, accesibles y eficientes tanto para los estudiantes como para los administradores del sistema.
        </p>

        <p>
          Este proyecto surge como respuesta a una problem√°tica com√∫n: la desorganizaci√≥n en los procesos de becas y la falta de comunicaci√≥n clara sobre el estado de las solicitudes. La aplicaci√≥n ofrece una plataforma donde los alumnos pueden consultar el estado de sus entrevistas, documentos y resultados, mientras que los administradores pueden gestionar convocatorias, validar aplicantes y controlar el flujo completo del proceso.
        </p>

        <p>
          Para su desarrollo se utilizaron tecnolog√≠as como <b>HTML, CSS, JavaScript, PHP y XAMPP</b>, adem√°s de herramientas de dise√±o como <b>Figma</b> para la creaci√≥n de prototipos y <b>GitHub</b> para la colaboraci√≥n del equipo durante el desarrollo.
        </p>

        <p>
          El sistema plantea diferentes vistas seg√∫n el tipo de usuario: estudiantes, administradores suplentes y administradores principales, cada uno con permisos y funciones espec√≠ficas.
        </p>

        <p>
          La aplicaci√≥n est√° dise√±ada como un proyecto funcional, modular y escalable, con la capacidad de crecer y adaptarse a necesidades reales dentro del entorno universitario.
        </p>
      </div>
    </div>

  </div>

  <div class="footer">
    <button onclick="showSection('validacion')">Editar</button>
    <button onclick="showSection('seguimiento')">Administraci√≥n</button>
    <button onclick="showSection('publicacion')">Gesti√≥n</button>
    <button onclick="showSection('preguntas')">Respuestas</button>
    <button onclick="showSection('acerca')">Acerca</button>
  </div>

  <!-- Modal para agregar entrevista -->
  <div id="interview-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Agendar Nueva Entrevista</h3>
        <button class="close-btn">&times;</button>
      </div>
      <form id="interview-form">
        <div class="form-group">
          <label for="modal-student-search">Seleccionar Estudiante:</label>
          <input type="text" id="modal-student-search" placeholder="Buscar estudiante...">
          <div class="student-list" id="modal-student-list">
            <div class="loading">Cargando estudiantes...</div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="interview-date">Fecha de la Entrevista:</label>
          <input type="date" id="interview-date" required>
        </div>
        
        <div class="form-group">
          <label for="interview-time">Hora de la Entrevista:</label>
          <input type="time" id="interview-time" required>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="cancel-interview">Cancelar</button>
          <button type="submit" class="btn btn-primary">Agendar Entrevista</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCw8ae27O1Bg8MNBZDKrB55jciUld6plOc",
      authDomain: "becauaqbd.firebaseapp.com",
      projectId: "becauaqbd",
      storageBucket: "becauaqbd.firebasestorage.app",
      messagingSenderId: "853997069826",
      appId: "1:853997069826:web:50e1a3812626cf4255a91b"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Variables globales
    let selectedStudentId = null;
    let currentDate = new Date();
    let estudiantes = [];
    let estudiantesConBecas = [];
    let entrevistas = [];
    let currentUser = null;

    // Cargar informaci√≥n del usuario actual
    function loadCurrentUser() {
      try {
        const userData = localStorage.getItem('usuario');
        if (userData) {
          currentUser = JSON.parse(userData);
          document.getElementById('admin-name').textContent = currentUser.nombre || 'Administrador';
          document.getElementById('admin-id').textContent = currentUser.id || 'ID-usuario';
          console.log('Usuario cargado:', currentUser);
        } else {
          console.warn('No se encontr√≥ informaci√≥n de usuario en localStorage');
        }
      } catch (error) {
        console.error('Error al cargar usuario:', error);
      }
    }

    function showSection(id) {
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      
      // Si se muestra la secci√≥n de entrevistas, actualizar el calendario
      if (id === 'seguimiento') {
        console.log('Cargando secci√≥n de entrevistas...');
        loadEstudiantes();
        updateWeekDisplay();
      }
      
      // Si se muestra la secci√≥n de gesti√≥n de becas, cargar estudiantes con estado de beca
      if (id === 'publicacion') {
        console.log('Cargando secci√≥n de gesti√≥n de becas...');
        loadEstudiantesConBecas();
      }
    }

    // Funciones para conexi√≥n con Firebase/Firestore
    async function loadEstudiantes() {
      try {
        console.log('Cargando estudiantes desde Firebase...');
        
        const querySnapshot = await db.collection('usuarios')
          .where('tipo', '==', 'estudiantes')
          .get();
        
        estudiantes = [];
        querySnapshot.forEach(doc => {
          const estudiante = doc.data();
          estudiante.id = doc.id;
          estudiantes.push(estudiante);
        });
        
        console.log('Total de estudiantes cargados:', estudiantes.length);
        
        // Si el modal est√° abierto, actualizar la lista
        if (document.getElementById('interview-modal').style.display === 'flex') {
          loadStudentList();
        }
        
        return estudiantes;
      } catch (error) {
        console.error('Error al cargar estudiantes:', error);
        const studentList = document.getElementById('student-list');
        if (studentList) {
          studentList.innerHTML = '<div class="error">Error al cargar estudiantes: ' + error.message + '</div>';
        }
        return [];
      }
    }

    // Cargar estudiantes con informaci√≥n de becas
    async function loadEstudiantesConBecas() {
      try {
        console.log('Cargando estudiantes con estado de beca...');
        
        const container = document.getElementById('students-container');
        container.innerHTML = '<div class="loading">Cargando estudiantes...</div>';
        
        // Cargar estudiantes
        const estudiantesSnapshot = await db.collection('usuarios')
          .where('tipo', '==', 'estudiantes')
          .get();
        
        estudiantesConBecas = [];
        
        // Cargar estados de beca
        const becasSnapshot = await db.collection('becas').get();
        const estadosBeca = {};
        
        becasSnapshot.forEach(doc => {
          estadosBeca[doc.id] = doc.data().activo || false;
        });
        
        estudiantesSnapshot.forEach(doc => {
          const estudiante = doc.data();
          estudiante.id = doc.id;
          estudiante.becaActiva = estadosBeca[doc.id] || false;
          estudiantesConBecas.push(estudiante);
        });
        
        console.log('Estudiantes con beca cargados:', estudiantesConBecas);
        renderStudentsGrid();
        
      } catch (error) {
        console.error('Error al cargar estudiantes con beca:', error);
        document.getElementById('students-container').innerHTML = 
          '<div class="error">Error al cargar estudiantes: ' + error.message + '</div>';
      }
    }

    // Renderizar la cuadr√≠cula de estudiantes
    function renderStudentsGrid(searchTerm = '') {
      const container = document.getElementById('students-container');
      
      if (estudiantesConBecas.length === 0) {
        container.innerHTML = '<div class="loading">No se encontraron estudiantes</div>';
        return;
      }
      
      const filteredStudents = estudiantesConBecas.filter(estudiante => {
        const nombre = estudiante.nombre || '';
        const id = estudiante.id || '';
        const searchText = searchTerm.toLowerCase();
        return nombre.toLowerCase().includes(searchText) || id.toLowerCase().includes(searchText);
      });
      
      if (filteredStudents.length === 0) {
        container.innerHTML = '<div class="loading">No se encontraron estudiantes que coincidan con la b√∫squeda</div>';
        return;
      }
      
      container.innerHTML = `
        <div class="students-grid">
          ${filteredStudents.map(estudiante => `
            <div class="student-card">
              <div class="student-info">
                <div class="student-field">
                  <span class="field-label">Nombre:</span>
                  <span class="field-value">${estudiante.nombre || 'No disponible'}</span>
                </div>
                <div class="student-field">
                  <span class="field-label">ID:</span>
                  <span class="field-value">${estudiante.id}</span>
                </div>
                <div class="student-field">
                  <span class="field-label">Correo:</span>
                  <span class="field-value">${estudiante.correo || 'No disponible'}</span>
                </div>
                <div class="student-field">
                  <span class="field-label">Tel√©fono:</span>
                  <span class="field-value">${estudiante.telefono || 'No disponible'}</span>
                </div>
              </div>
              <div class="status-section">
                <span class="field-label">Estado de Beca:</span>
                <div class="status-toggle" onclick="toggleBecaStatus('${estudiante.id}')">
                  <div class="status-indicator ${estudiante.becaActiva ? 'status-active' : 'status-inactive'}"></div>
                  <span class="status-text ${estudiante.becaActiva ? 'status-active-text' : 'status-inactive-text'}">
                    ${estudiante.becaActiva ? 'Activo' : 'Inactivo'}
                  </span>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Alternar estado de beca
    async function toggleBecaStatus(studentId) {
      try {
        const estudiante = estudiantesConBecas.find(e => e.id === studentId);
        if (!estudiante) {
          alert('Error: Estudiante no encontrado');
          return;
        }
        
        const nuevoEstado = !estudiante.becaActiva;
        
        // Actualizar en Firebase
        await db.collection('becas').doc(studentId).set({
          activo: nuevoEstado,
          estudianteId: studentId,
          estudianteNombre: estudiante.nombre,
          actualizadoPor: currentUser ? currentUser.nombre : 'Administrador',
          fechaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        // Actualizar estado local
        estudiante.becaActiva = nuevoEstado;
        
        // Re-renderizar la cuadr√≠cula
        const searchTerm = document.getElementById('student-search').value;
        renderStudentsGrid(searchTerm);
        
        console.log(`Estado de beca actualizado para ${estudiante.nombre}: ${nuevoEstado ? 'Activo' : 'Inactivo'}`);
        
      } catch (error) {
        console.error('Error al actualizar estado de beca:', error);
        alert('Error al actualizar el estado de la beca: ' + error.message);
      }
    }

    // El resto del c√≥digo para entrevistas permanece igual...
    async function loadEntrevistas(startDate) {
      try {
        console.log('Cargando entrevistas desde Firebase...');
        
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 7);
        
        const querySnapshot = await db.collection('entrevista').get();
        
        entrevistas = [];
        querySnapshot.forEach(doc => {
          const entrevista = doc.data();
          entrevista.id = doc.id;
          
          let fechaEntrevista;
          if (entrevista.fecha && entrevista.fecha.toDate) {
            fechaEntrevista = entrevista.fecha.toDate();
          } else if (entrevista.Fecha && entrevista.Fecha.toDate) {
            fechaEntrevista = entrevista.Fecha.toDate();
          } else if (entrevista.fecha) {
            fechaEntrevista = new Date(entrevista.fecha);
          } else if (entrevista.Fecha) {
            fechaEntrevista = new Date(entrevista.Fecha);
          } else {
            console.warn('Entrevista sin fecha v√°lida:', entrevista);
            return;
          }
          
          entrevista.fechaObj = fechaEntrevista;
          
          if (fechaEntrevista >= startDate && fechaEntrevista <= endDate) {
            entrevistas.push(entrevista);
          }
        });
        
        console.log('Total de entrevistas para esta semana:', entrevistas.length);
        populateCalendar();
        
      } catch (error) {
        console.error('Error al cargar entrevistas:', error);
        document.querySelectorAll('.day-column').forEach(column => {
          column.innerHTML = '<div class="error">Error al cargar entrevistas: ' + error.message + '</div>';
        });
      }
    }

    async function getNextInterviewId() {
      try {
        const querySnapshot = await db.collection('entrevista').get();
        let maxId = 0;
        
        querySnapshot.forEach(doc => {
          const data = doc.data();
          if (data.id_entrevista && data.id_entrevista > maxId) {
            maxId = data.id_entrevista;
          }
        });
        
        return maxId + 1;
      } catch (error) {
        console.error('Error al obtener siguiente ID:', error);
        return 1;
      }
    }

    async function saveEntrevista(entrevistaData) {
      try {
        const nextId = await getNextInterviewId();
        
        const fechaCompleta = new Date(entrevistaData.Fecha);
        
        const entrevistaToSave = {
          Entrevistador: currentUser ? currentUser.nombre : "Administrador",
          estudiante: entrevistaData.Nombre_Estudiante,
          fecha: fechaCompleta,
          id_entrevista: nextId,
          id_estudiante: entrevistaData.ID_Estudiante
        };
        
        console.log('Guardando entrevista:', entrevistaToSave);
        
        const docRef = await db.collection('entrevista').add(entrevistaToSave);
        return { success: true, id: docRef.id };
      } catch (error) {
        console.error('Error al guardar entrevista:', error);
        return { success: false, message: error.message };
      }
    }

    function populateCalendar() {
      console.log('Poblando calendario con', entrevistas.length, 'entrevistas');
      
      document.querySelectorAll('.day-column').forEach(column => {
        column.innerHTML = '';
      });
      
      entrevistas.forEach(entrevista => {
        const fechaEntrevista = entrevista.fechaObj;
        const dayOfWeek = fechaEntrevista.getDay();
        const dayColumn = document.querySelector(`.day-column[data-day="${dayOfWeek}"]`);
        
        if (dayColumn) {
          const interviewCard = document.createElement('div');
          interviewCard.className = 'interview-card';
          interviewCard.innerHTML = `
            <div class="interview-time">${fechaEntrevista.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}</div>
            <div class="interview-candidate">${entrevista.estudiante || entrevista.Nombre_Estudiante}</div>
            <div class="interview-position">Entrevistador: ${entrevista.Entrevistador || entrevista.Nombre_Administrador}</div>
          `;
          dayColumn.appendChild(interviewCard);
        }
      });
      
      document.querySelectorAll('.day-column').forEach(column => {
        if (column.children.length === 0) {
          const emptyMessage = document.createElement('div');
          emptyMessage.className = 'empty-day';
          emptyMessage.textContent = 'No hay entrevistas programadas';
          column.appendChild(emptyMessage);
        }
      });
    }

    // Inicializaci√≥n cuando el DOM est√° listo
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM cargado, inicializando aplicaci√≥n...');
      
      loadCurrentUser();
      
      // Configurar b√∫squeda en gesti√≥n de becas
      const searchInput = document.getElementById('student-search');
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          renderStudentsGrid(this.value);
        });
      }
      
      // El resto del c√≥digo de inicializaci√≥n para entrevistas...
      const prevWeekBtn = document.getElementById('prev-week');
      const nextWeekBtn = document.getElementById('next-week');
      const todayBtn = document.getElementById('today');
      const currentWeekElement = document.getElementById('current-week');
      const addInterviewBtn = document.getElementById('add-interview-btn');
      const modal = document.getElementById('interview-modal');
      const closeBtn = document.querySelector('.close-btn');
      const cancelBtn = document.getElementById('cancel-interview');
      const modalStudentSearch = document.getElementById('modal-student-search');
      const modalStudentList = document.getElementById('modal-student-list');
      const interviewForm = document.getElementById('interview-form');
      
      loadEstudiantes();
      
      addInterviewBtn.addEventListener('click', function() {
        selectedStudentId = null;
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('interview-date').min = today;
        document.getElementById('interview-date').value = '';
        document.getElementById('interview-time').value = '';
        modalStudentSearch.value = '';
        loadStudentList();
        modal.style.display = 'flex';
      });
      
      closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
      });
      
      cancelBtn.addEventListener('click', function() {
        modal.style.display = 'none';
      });
      
      window.addEventListener('click', function(event) {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
      
      modalStudentSearch.addEventListener('input', function() {
        loadStudentList(this.value);
      });
      
      interviewForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!selectedStudentId) {
          alert('Por favor, seleccione un estudiante');
          return;
        }
        
        const date = document.getElementById('interview-date').value;
        const time = document.getElementById('interview-time').value;
        
        if (!date || !time) {
          alert('Por favor, complete la fecha y hora de la entrevista');
          return;
        }
        
        const estudiante = estudiantes.find(e => e.id === selectedStudentId);
        if (!estudiante) {
          alert('Error: Estudiante no encontrado');
          return;
        }
        
        const nuevaEntrevista = {
          Nombre_Estudiante: estudiante.nombre || `Estudiante ${estudiante.id}`,
          ID_Estudiante: estudiante.id,
          Nombre_Administrador: currentUser ? currentUser.nombre : 'Administrador',
          Fecha: `${date}T${time}`
        };
        
        console.log('Creando nueva entrevista:', nuevaEntrevista);
        
        const result = await saveEntrevista(nuevaEntrevista);
        
        if (result.success) {
          updateWeekDisplay();
          modal.style.display = 'none';
          alert('Entrevista agendada exitosamente');
        } else {
          alert('Error al agendar entrevista: ' + result.message);
        }
      });
      
      function loadStudentList(searchTerm = '') {
        modalStudentList.innerHTML = '';
        
        if (estudiantes.length === 0) {
          modalStudentList.innerHTML = '<div class="loading">Cargando estudiantes...</div>';
          return;
        }
        
        const filteredStudents = estudiantes.filter(estudiante => {
          const nombre = estudiante.nombre || `Estudiante ${estudiante.id}`;
          return nombre.toLowerCase().includes(searchTerm.toLowerCase());
        });
        
        if (filteredStudents.length === 0) {
          modalStudentList.innerHTML = '<div class="student-item">No se encontraron estudiantes</div>';
          return;
        }
        
        filteredStudents.forEach(estudiante => {
          const studentItem = document.createElement('div');
          studentItem.className = 'student-item';
          studentItem.textContent = estudiante.nombre || `Estudiante ${estudiante.id}`;
          studentItem.addEventListener('click', function() {
            document.querySelectorAll('.student-item').forEach(item => {
              item.classList.remove('selected-student');
            });
            
            studentItem.classList.add('selected-student');
            selectedStudentId = estudiante.id;
            modalStudentSearch.value = estudiante.nombre || `Estudiante ${estudiante.id}`;
          });
          
          modalStudentList.appendChild(studentItem);
        });
      }
      
      function updateWeekDisplay() {
        const startOfWeek = new Date(currentDate);
        startOfWeek.setDate(currentDate.getDate() - currentDate.getDay() + 1);
        startOfWeek.setHours(0, 0, 0, 0);
        
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        endOfWeek.setHours(23, 59, 59, 999);
        
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        currentWeekElement.textContent = `Semana del ${startOfWeek.toLocaleDateString('es-ES', options)} al ${endOfWeek.toLocaleDateString('es-ES', options)}`;
        
        loadEntrevistas(startOfWeek);
      }
      
      prevWeekBtn.addEventListener('click', function() {
        currentDate.setDate(currentDate.getDate() - 7);
        updateWeekDisplay();
      });
      
      nextWeekBtn.addEventListener('click', function() {
        currentDate.setDate(currentDate.getDate() + 7);
        updateWeekDisplay();
      });
      
      todayBtn.addEventListener('click', function() {
        currentDate = new Date();
        updateWeekDisplay();
      });
      
      updateWeekDisplay();
    });
  </script>

</body>
</html>